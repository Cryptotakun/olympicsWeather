usethis::use_r("get_weather_forecast")
library(tidygeocoder)
library(usethis)
library(roxygen2)
library(usethis)
library(lubridate)
library(ggplot2)
library(devtools)
library(httr2)
library(jsonlite)
library(tibble)
library(purrr)
#' Effectue une requête à l'API météorologique pour obtenir les prévisions météo.
#'
#'
#' Cette fonction interagit avec une API météorologique en utilisant les coordonnées GPS (latitude, longitude) en entrée,
#' récupérant ainsi les prévisions météo pour cette localisation spécifique. Les données sont retournées sous forme de tableau
#' organisé pour une utilisation facile.
#'
#' @param lat La latitude (numeric).
#' @param lon La longitude (numeric).
#'
#' @export
perform_request <- function(lat, lon) {
url <- "https://api.open-meteo.com/v1/forecast"
request(url) |>
req_url_query(latitude=lat,longitude=lon, hourly= c("temperature_2m","apparent_temperature","precipitation_probability","precipitation"), .multi = "comma"
) |>
req_perform() |>
resp_body_json() |>
as_tibble ()
}
#' Transforme la tibble obtenue de la requête en une structure de données spécifique.
#'
#' Cette fonction prend en entrée la tibble obtenue de la requête et la transforme pour
#' obtenir une nouvelle tibble avec les informations nécessaires.
#'
#' @param extraction sert a extraire les différentes colonnes de la liste de données
#'
#' @export
unnest_response <- function(extraction){
hourly_data <- extraction$hourly
if (length(hourly_data) == 0) {
stop("Aucune donnée dans la colonne 'hourly'.")
}
output_tibble <- tibble(
"date_heure" = ymd_hm(unlist(hourly_data[[1]])),
"temperature_celsius" = unlist(hourly_data[[2]]),
"temperature_ressentie_celsius" = unlist(hourly_data[[3]]),
"precipitation_proba" = unlist(hourly_data[[4]]),
"precipitation" = unlist(hourly_data[[5]])
)
}
#' Géocode une adresse pour obtenir ses coordonnées GPS.
#'
#' Cette fonction permet de convertir une adresse donnée en coordonnées géographiques (latitude, longitude).
#' En entrée, elle accepte une adresse textuelle et renvoie les coordonnées GPS correspondantes sous forme d'un vecteur
#' numérique de taille 2.
#'
#' @param adresse Une adresse sous forme de texte.
#'
#' @return Un vecteur numérique de taille 2 avec les coordonnées GPS (latitude, longitude).
#'
#' @export
address_to_gps <- function(adresse) {
df_adresse <- data.frame("nom" = character(), addr = character(), stringsAsFactors = FALSE)
df_adresse <- rbind(df_adresse, data.frame(addr = adresse), stringsAsFactors = FALSE)
resultat_geocodage <- df_adresse |>
geocode(addr, method = 'arcgis')
df_adresse <- resultat_geocodage
}
#' Convertit une adresse en coordonnées géographiques.
#'
#' Cette fonction accepte une adresse textuelle en entrée et retourne les coordonnées GPS correspondantes.
#'
#' @param address Une adresse sous forme de texte.
#'
#' @return Un vecteur numérique contenant les coordonnées géographiques (latitude, longitude).
#'
#' @export
get_gps_coordinate <- function(address) {
coord_df <- address_to_gps(address)
latitude <- coord_df$lat
longitude <- coord_df$long
coordinates <- c(latitude[1], longitude[1])
}
#' Obtient les prévisions météo en fonction des coordonnées GPS.
#'
#' Cette fonction prend en entrée un vecteur numérique de taille 2 (latitude, longitude)
#' et renvoie les prévisions météo sous forme de tibble.
#'
#' @param xy Un vecteur numérique de taille 2 représentant les coordonnées GPS.
#'
#' @return Un tibble avec les prévisions météo.
#'
#' @seealso \code{\link{perform_request}}, \code{\link{unnest_response}}
#'
#' @export
get_forecast.numeric <- function(xy) {
if (!is.numeric(xy) || length(xy) != 2) {
stop("L'argument xy doit être un vecteur numérique de taille 2 (latitude, longitude).")
}
response_table <- perform_request(xy[1], xy[2])
unnested_table <- unnest_response(response_table)
}
#' Obtient les prévisions météo basées sur une adresse.
#'
#' Cette fonction récupère les prévisions météo en fonction d'une adresse fournie en entrée.
#' Elle commence par convertir l'adresse en coordonnées GPS, puis utilise ces coordonnées
#' pour obtenir les prévisions météo.
#'
#' @param address Une adresse textuelle.
#'
#' @return Un tibble contenant les prévisions météo.
#'
#' @seealso \code{\link{address_to_gps}}, \code{\link{get_forecast.numeric}}
#'
#' @export
get_forecast.character <- function(address) {
if (!is.character(address) || length(address) != 1) {
stop("L'argument address doit être de type character et de taille 1.")
}
coordinates <- get_gps_coordinate(address)
response_table <- perform_request(coordinates[1],coordinates[2])
unnested_table <- unnest_response(response_table)
}
#' Obtient les prévisions météo en fonction des coordonnées GPS ou d'une adresse spécifiée.
#'
#' Cette fonction polyvalente permet d'accéder aux prévisions météo en utilisant soit les coordonnées GPS
#' (latitude, longitude) soit une adresse précise.
#'
#' @param x Un vecteur numérique de taille 2 représentant les coordonnées GPS (latitude, longitude) ou une adresse au format caractère.
#' @return Un tibble contenant les prévisions météo, incluant des informations telles que la date, l'heure UTC, la température,
#' la température ressentie, la probabilité de précipitation et la quantité de précipitation.
#'
#' @examples
#' # Obtenir les prévisions météo pour des coordonnées GPS
#' xy_coordinates <- c(48.85, 2.35)
#' forecast_result <- get_forecast(xy_coordinates)
#' print(forecast_result)
#'
#' # Obtenir les prévisions météo pour une adresse
#' address_result <- get_forecast("9 Quai Henri Barbusse, Nantes, 44000, FRANCE")
#' print(address_result)
#'
#' @seealso \code{\link{get_forecast.numeric}} et \code{\link{get_forecast.character}}
#'
#' @export
get_forecast <- function(x) {
if (is.numeric(x)) {
result <- get_forecast.numeric(x)
} else if (is.character(x)) {
result <- get_forecast.character(x)
} else {
stop("L'un des arguments 'x' ou 'address' doit être spécifié.")
}
print(graph_function(result))
return(result)
}
library(tidygeocoder)
library(usethis)
library(roxygen2)
library(usethis)
library(lubridate)
library(ggplot2)
library(devtools)
library(httr2)
library(jsonlite)
library(tibble)
library(purrr)
document()
document()
library(tidygeocoder)
library(usethis)
library(roxygen2)
library(usethis)
library(lubridate)
library(ggplot2)
library(devtools)
library(httr2)
library(jsonlite)
library(tibble)
library(purrr)
